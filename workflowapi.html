<!DOCTYPE html>
<html lang="en">
<head>
  <title>Workflow REST API</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <link rel="stylesheet" type="text/css" href="media/css/style.css">
  <style>

#logo {
  color: #aa0000;
}

</style>

  <script type="text/javascript" src="media/js/jquery-1.4.2.min.js"></script>

</head>
<body>
<div id="wrapper">
<div id="main">

<header id="header">
  <span id="logo">Workflow REST API</span>
  <span id="tocbox">
    <span id="tocbutton" class="navbutton">Table of Contents</span>
    <div id="toc" style="display: none">
      
    </div>
  </span>
</header>
    <div id="content">
<h1>Workflow REST API</h1>

<p>This document describes the HTTP REST API for workflows and tasks, and for the
creation of Jobs and tracking their execution progress.</p>

<p><strong>This API speaks only JSON</strong>. For every request. For all the HTTP methods.
This means that any <code>POST</code> or <code>PUT</code> request, the <code>Content-Type</code> <strong>must be
JSON</strong>.</p>

<p>(See <a href="index.html">node-workflow</a> docs for information on the whole module,
not just the REST API).</p>

<p># End-Points</p>

<p>The API is composed by the following end-points:</p>

<ul>
<li><code>/workflows</code></li>
<li><code>/jobs</code></li>
<li><code>/jobs/:uuid/info</code></li>
<li><code>/stats</code> (since version <code>0.10.0</code>)</li>
</ul>

<p><code>/workflows</code> accept any of the HTTP verbs for the usual CRUD, but <code>/jobs</code> will
not accept <code>PUT</code> since the only way to modify a Job once it has been created is
through the job's execution.</p>

<p>For the same reason, <code>/jobs/:uuid/info</code> will not accept neither <code>POST</code> (since the
staus information for a Job is created when the Job itself is created), nor
<code>DELETE</code> (given the status information for a job will be removed only if the job
is removed).</p>

<h2>GET /workflows</h2>

<p>Retrieve a list of all the existing workflows.</p>

<h3>HTTP Parameters.</h3>

<p>None.</p>

<h3>Status Codes</h3>

<ul>
<li><code>200 OK</code>: A list of existing workflows is returned. If there are no workflows,
        an empty array is returned.</li>
</ul>

<p>### Response Body</p>

<p>An array of workflow objects (see <code>POST /workflows</code>).</p>

<h2>POST /workflows</h2>

<p>Create a new workflow.</p>

<h3>HTTP Parameters</h3>

<ul>
<li><code>name</code>: Required. The workflow name.</li>
<li><code>chain[]</code>: Optional. The tasks to add to the workflow. Multiple values
allowed.</li>
<li><code>onerror[]</code>: Optional. The tasks to add to the workflow fallback. Multiple
values allowed.</li>
<li><code>timeout</code>: Optional. Timeout in seconds for workflow execution.</li>
</ul>

<h3>Every <code>task</code> may be composed of:</h3>

<ul>
<li><code>name</code>: Optional. The task name.</li>
<li><code>body</code>: Required. A string enclosing a JavaScript function definition.
The function <strong>must</strong> take the parameters <code>job</code> and <code>cb</code>, where <code>cb</code> is a
callback to be called by the function when its execution is finished. If the
task succeeded, invoke the cb without arguments. If the task failed, invoke
the cb with an error mssage.</li>
<li><code>fallback</code>: Optional. A string enclosing a JavaScript function definition.
The function <strong>must</strong> take the parameters <code>err</code>, <code>job</code> and <code>cb</code>, where <code>cb</code>
is a callback to be called by the function when its execution fails;
<code>err</code> is the error message returned by task <code>body</code>.</li>
<li><code>retry</code>: Optional. Number of times to retry the task's body before either
failing the task, or calling the <code>fallback</code> function (when given).</li>
<li><code>timeout</code>: Optional. Timeout in seconds for task execution.</li>
</ul>

<h3>Status Codes</h3>

<ul>
<li><code>409 Conflict</code>: One of the required parameters is either missing or incorrect.
Information about the missing/incorrect parameter will be included in the
response body.</li>
<li><code>201 Created</code>: Successful creation of the workflow. The workflow's JSON
representation will be included in the response body, together with a
<code>Location</code> header for the new resource. A workflow's generated <code>uuid</code> will be
part of this <code>Location</code>, and a member of the returned workflow JSON object.</li>
</ul>

<p>#### Response Body:</p>

<pre><code>{
  uuid: UUID,
  name: 'The workflow name',
  chain: [:task, :task, ...],
  onerror: [:task, :task, ...],
  timeout: 3600
}
</code></pre>

<h4>Sample task in the response:</h4>

<pre><code>{
  uuid: UUID,
  name: 'The task name',
  body: "function(job, cb) {
    if (job.foo) {
      return cb(null);
    } else {
      return cb('Uh, oh!, no foo.');
    }
  }",
  fallback: "function(err, job, cb) {
    if (err === 'Uh, oh!, no foo.') {
      job.foo = 'bar';
      return cb(null);
    } else {
      return cb('Arise chicken, arise!');
    }
  }",
  timeout: 360
}
</code></pre>

<h2>GET /workflows/:wf_uuid</h2>

<p>### HTTP Parameters:</p>

<ul>
<li><code>wf_uuid</code>: The workflow UUID.</li>
</ul>

<h3>Status Codes:</h3>

<ul>
<li><code>404 Not Found</code>: There's no worlflow with the provided <code>wf_uuid</code>.</li>
<li><code>200 OK</code>: The workflow with the provided <code>wf_uuid</code> has been found and is
returned as response body.</li>
</ul>

<p>Note this API will not keep track of <em>destroyed</em> workflows. When a request for
destroyed workflows is made, the HTTP Status code will be <code>404 Not Found</code>
instead of <code>410 Gone</code>.</p>

<h3>Response body</h3>

<p>Same as for <code>POST /workflows</code> + <code>wf_uuid</code>.</p>

<h2>PUT /workflows/:wf_uuid</h2>

<h3>HTTP Parameters</h3>

<p>Same as for <code>POST /workflows</code>.</p>

<p>### Status Codes</p>

<p>Same as for <code>POST /workflows</code> with the addition of:</p>

<ul>
<li><code>404 Not Found</code>, when the provided <code>wf_uuid</code> cannot be found on the backend.</li>
</ul>

<p>### Response body</p>

<p>Same as for <code>POST /workflows</code>.</p>

<h2>DELETE /workflows/:wf_uuid</h2>

<p>### HTTP Parameters:</p>

<ul>
<li><code>wf_uuid</code>: The workflow UUID.</li>
</ul>

<h3>Status Codes</h3>

<ul>
<li><code>204 OK</code>: Workflow successfully destroyed.</li>
</ul>

<h2>GET /jobs</h2>

<p>Retrieve a list of jobs. Without an <code>execution</code> HTTP parameter, all the existing
jobs will be retrieved. If <code>execution</code> is given, only the jobs with the given
execution status are retrieved.</p>

<h3>HTTP Parameters.</h3>

<ul>
<li><code>execution</code>: Optional. One of <code>succeeded</code>, <code>failed</code>, <code>running</code>, 'canceled'
or <code>queued</code>.</li>
</ul>

<h3>Status Codes</h3>

<ul>
<li><code>200 OK</code>: A list of existing jobs is returned, even when it's empty.</li>
</ul>

<h2>POST /jobs</h2>

<h3>HTTP Parameters.</h3>

<ul>
<li><code>workflow</code>: Required. UUID of the workflow from which the new job will be
created.</li>
<li><code>exec_after</code>: Optional. ISO 8601 Date. Delay job execution until the provided
time.</li>
<li><code>target</code>: The job's target, intended to restrict the creation of another job
with this same target and parameters until this job completes.</li>
<li>Any extra <code>k/v</code> pairs of parameters desired, which will be passed to the job
object as an object like <code>{k1: v1, k2: v2, ...}</code>.</li>
</ul>

<h3>Status Codes</h3>

<ul>
<li><code>409 Conflict</code>: One of the required parameters is either missing or incorrect.
Information about the missing/incorrect parameter will be included in the
response body.</li>
<li><code>201 Created</code>: Successful creation of the job. The job's JSON representation
will be included in the the response body together with a <code>Location</code> header
for the new resource. The job's generated <code>uuid</code> will be part of this
<code>Location</code>, and a member of the returned job JSON object.</li>
</ul>

<p>### Response Body</p>

<pre><code>{
  uuid: UUID,
  workflow_uuid: wf_uuid,
  name: 'The workflow name',
  chain: ['task object', 'task object', ...],
  onerror: ['task object', 'task object', ...],
  timeout: 3600,
  exec_after: new Date().toISOString(),
  target: '/some/uri',
  params: {
    k1: v1,
    k2: v2
  },
  chain_results: [{result: 'OK', error: ''}, ...],
  onerror_results: [{result: 'OK', error: ''}, ...],
  execution: 'queued' ('running'|'failure'|'success')
}
</code></pre>

<h2>GET /jobs/:job_uuid</h2>

<h3>HTTP Parameters.</h3>

<ul>
<li><code>job_uuid</code>: The job's UUID.</li>
</ul>

<h3>Status Codes</h3>

<ul>
<li><code>404 Not Found</code>: There's no job with the provided <code>job_uuid</code>.</li>
<li><code>200 OK</code>: The task with the provided <code>job_uuid</code> has been found and is
returned as response body.</li>
</ul>

<p>Note this API will not keep track of <em>destroyed</em> workflows. When a request for
destroyed workflows is made, the HTTP Status code will be <code>404 Not Found</code>
instead of <code>410 Gone</code>.</p>

<p>### Response Body</p>

<p>Same as for <code>POST /jobs</code>.</p>

<h2>PUT /jobs/:job_uuid</h2>

<p><strong>TBD</strong>. Response with status code <code>405 Method Not Allowed</code>.</p>

<h2>DELETE /jobs/:job_uuid</h2>

<p><strong>TBD</strong>. Response with status code <code>405 Method Not Allowed</code>.</p>

<h2>POST /jobs/:job_uuid/cancel</h2>

<p>Cancel a job's execution. Only unfinished jobs can be canceled.</p>

<h3>HTTP Parameters.</h3>

<ul>
<li><code>job_uuid</code>: The job's UUID.</li>
</ul>

<h3>Status Codes</h3>

<ul>
<li><code>404 Not Found</code>: There's no job with the provided <code>job_uuid</code>.</li>
<li><code>409 Conflict</code>: The job is already finalized and cannot be canceled.</li>
<li><code>200 OK</code>: Successfully canceled job.</li>
</ul>

<p>### Response Body</p>

<p>Same than for <code>POST /jobs</code>.</p>

<h2>POST /jobs/:job_uuid/resume</h2>

<p>Resumes a job's execution which was previously set to waiting by any of the Job
tasks. The job should have a <em>waiting</em> status in order to resume it.</p>

<p>Depending on the given parameters, the job will be either <em>re-queued</em> or flagged
as <em>failed</em>. The <code>chain_results</code> entry for the task which set the job to
<code>waiting</code> will be updated with the given <code>result</code> or <code>error</code> messages.</p>

<p>On success, <em>resume</em> the job will set its status from <em>waiting</em> to <em>queued</em>
again. The job will run once one of the runners has a free slot to run it.</p>

<h3>HTTP Parameters.</h3>

<ul>
<li><code>job_uuid</code>: The job's UUID.</li>
<li><code>result</code>: Optional. Result message from the remote task if it runs okay.
Defaults to <em>"OK"</em>.</li>
<li><code>error</code>: Optional. Error message for the remote task. Note that providing any
value for this parameter means you want to fail the job.</li>
</ul>

<h3>Status Codes</h3>

<ul>
<li><code>404 Not Found</code>: There's no job with the provided <code>job_uuid</code>.</li>
<li><code>409 Conflict</code>: The job is not waiting and cannot be resumed.</li>
<li><code>200 OK</code>: Successfully resumed job.</li>
</ul>

<p>### Response Body</p>

<p>Same than for <code>POST /jobs</code>.</p>

<h2>GET /jobs/:job_uuid/info</h2>

<p>Detailed information about the given job. A task may cause a 3rd-party
application to execute a process which may require some time to finish. While
our task is running and waiting for the finalization of such a process, those
3rd-party applications can publish information about progress using
<code>POST /jobs/:job_uuid/info</code>; this information can then being used by other
applications interested in job results using <code>GET /jobs/:job_uuid/info</code>.</p>

<p>This information will consist of an arbitrary-length array, where every <code>POST</code>
request will result in a new member being appended.</p>

<h3>HTTP Parameters.</h3>

<ul>
<li><code>job_uuid</code>: The job's UUID.</li>
</ul>

<h3>Status Codes</h3>

<p>Same as for <code>GET /jobs/:job_uuid</code>.</p>

<p>### Response Body</p>

<pre><code>[
  { '10%': 'Task completed step one' },
  { '20%': 'Task completed step two' }
]
</code></pre>

<h2>POST /jobs/:job_uuid/info</h2>

<h3>HTTP Parameters.</h3>

<ul>
<li><p><code>message</code>: Required. Object containing a message regarding the progress of
operations.</p>

<p>{ '10%': 'Task completed step one' }</p></li>
</ul>

<p>Note you can provide any key/value pair here.</p>

<h3>Status Codes</h3>

<p>Same as for <code>GET /jobs/:job_uuid</code>.</p>

<p>### Response Body</p>

<p>None.</p>

<h2>PUT /jobs/:job_uuid/info</h2>

<p>Response with status code <code>405 Method Not Allowed</code>.</p>

<h2>DELETE /jobs/:job_uuid/info</h2>

<p>Response with status code <code>405 Method Not Allowed</code>.</p>

<h2>GET /stats</h2>

<p>Returns a list of statistics for the current, past hour, past day and all time
system status, in terms of number of jobs on each one of the execution satatus</p>

<h3>HTTP Parameters.</h3>

<ul>
<li>none</li>
</ul>

<h3>Status Codes</h3>

<ul>
<li><code>200 OK</code>: A list of stats is returned, even when it's all zero counters.</li>
</ul>

<p>### Response Body</p>

<p>Something with the following members but, most likely, with different numbers:</p>

<pre><code>    { all_time:
       { queued: 0,
         failed: 0,
         succeeded: 0,
         canceled: 0,
         running: 0,
         retried: 0,
         waiting: 0 },
      past_24h:
       { queued: 0,
         failed: 0,
         succeeded: 0,
         canceled: 0,
         running: 0,
         retried: 0,
         waiting: 0 },
      past_hour:
       { queued: 0,
         failed: 0,
         succeeded: 0,
         canceled: 0,
         running: 0,
         retried: 0,
         waiting: 0 },
      current:
       { queued: 2,
         failed: 0,
         succeeded: 0,
         canceled: 0,
         running: 0,
         retried: 0,
         waiting: 0 } }
</code></pre>

<p>Please, note that <code>all_time</code> member does not contains results contained into
<code>past_24h</code>, neither this one contains results already contained into
<code>past_hour</code>, and this one ... you got it!.</p>

<p><style>#forkongithub a{background:#600;color:#fff;text-decoration:none;font-family:arial, sans-serif;text-align:center;font-weight:bold;padding:5px 40px;font-size:1rem;line-height:2rem;position:relative;transition:0.5s;}#forkongithub a:hover{background:#000;color:#fff;}#forkongithub a::before,#forkongithub a::after{content:"";width:100%;display:block;position:absolute;top:1px;left:0;height:1px;background:#fff;}#forkongithub a::after{bottom:1px;top:auto;}@media screen and (min-width:800px){#forkongithub{position:absolute;display:block;top:0;right:0;width:200px;overflow:hidden;height:200px;}#forkongithub a{width:200px;position:absolute;top:60px;right:-60px;transform:rotate(45deg);-webkit-transform:rotate(45deg);box-shadow:4px 4px 10px rgba(0,0,0,0.8);}}</style><span id="forkongithub"><a href="https://github.com/kusor/node-workflow">Fork me on GitHub</a></span></p>

    </div>
</div> <!-- end of #main -->
</div> <!-- end of #wrapper -->


<script type="text/javascript" charset="utf-8">
$(function () {
    $("#toc").click(function(event) {
        // This to ensure clicks in the #toc don't make it up to the
        // `closeTocOnBodyClick` handler.
        event.stopPropagation();
    });
    $("#toc a").click(function(event) {
        $("#tocbutton").click();
    })
    $("#tocbutton").click(function(event) {
        var target = $("#toc");
        if (target.css("display") !== "block") {
            $("body").bind("click.tocCloser", function(event) {
                $("#tocbutton").click();
                event.stopPropagation();
            });
        } else {
            $("body").unbind("click.tocCloser");
        }
        target.slideToggle(100);
        event.stopPropagation();
    });
});
</script>

</body>
</html>
